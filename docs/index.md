A tutorial on Lipid Structure Enrichment Analysis (LSEA)
================

### load package and example data

``` r
library(lsea)
# load example lipidomic composition data generated by adding random noise to real data
data(comp_data)
# load group labels (A or B) for differential testing and enrichment analysis
data(labels)
```

## CLR transformation

``` r
#transform composition data (samples x features) using centered log-ratio transformation
# note: this is not for normalized abundance data!!
clr_data <- lsea::clr.transform(comp_data)
# subsequent functions expect samples as columns
clr_mat <- data.matrix(t(clr_data))
```

## Differential composition testing

``` r
# to perform a paired t-test (samples must be ordered by pair)
t_df <- lsea::two.group.row.test(clr_mat, labels, test = "t", paired = TRUE)
# to perform unpaired wilcox test
# note: wilcox test will throw warnings for every row with ties, so suppress those warnings
w_df <- suppressWarnings(lsea::two.group.row.test(clr_mat, labels, test = "w", paired = FALSE))
```

##### t-test results ordered by p-value

|                |      stat |      mean1 |     mean2 |        dm |    pvalue |      padj |
|:---------------|----------:|-----------:|----------:|----------:|----------:|----------:|
| TG 56:4-FA20:3 |  4.396256 |  1.4517529 | -2.892099 |  4.343852 | 0.0001654 | 0.1476720 |
| TG 49:3-FA18:3 |  3.827157 |  2.1155015 | -2.453107 |  4.568608 | 0.0007326 | 0.2358636 |
| TG 54:5-FA16:0 | -3.664517 | -1.9583616 |  1.941328 | -3.899689 | 0.0011143 | 0.2358636 |
| FA 20:3        |  3.635246 |  1.3916176 | -1.973312 |  3.364929 | 0.0012011 | 0.2358636 |
| TG 52:6-FA20:5 |  3.598200 |  2.5091510 | -1.210132 |  3.719283 | 0.0013206 | 0.2358636 |
| PC 18:2_20:2   | -3.244180 | -0.7073557 |  2.084001 | -2.791356 | 0.0032283 | 0.4616506 |

##### Wilcoxon test results ordered by p-value

|                | stat |      mean1 |      mean2 |        dm |    pvalue |      padj |
|:---------------|-----:|-----------:|-----------:|----------:|----------:|----------:|
| PC 16:1_18:1   |  625 |  3.0007067 | -0.2891511 |  3.289858 | 0.0000017 | 0.0015611 |
| FA 16:0        |  148 | -0.3826287 |  2.6278213 | -3.010450 | 0.0001078 | 0.0358698 |
| CE 18:1        |  153 | -0.5924634 |  2.7080542 | -3.300518 | 0.0001607 | 0.0358698 |
| PE P-16:0/16:1 |  576 |  2.4939921 | -0.2272526 |  2.721245 | 0.0001607 | 0.0358698 |
| TG 52:6-FA20:5 |  551 |  2.5091510 | -1.2101318 |  3.719283 | 0.0009932 | 0.1446534 |
| TG 46:1-FA16:1 |  550 |  2.1788510 | -0.6821682 |  2.861019 | 0.0010621 | 0.1446534 |

## LSEA

``` r
# we can use the t-statistic to rank lipid species and perform enrichment analysis using the GSEA algorithm
# note: the returned Wilcoxon statistic is not directional
res <- lsea(t_df, rnk_name = "stat")
```

##### Top 5 positive results

<table class=" lightable-material lightable-striped" style="color: black; font-family: &quot;Source Sans Pro&quot;, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
pathway
</th>
<th style="text-align:right;">
pval
</th>
<th style="text-align:right;">
padj
</th>
<th style="text-align:right;">
ES
</th>
<th style="text-align:right;">
NES
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
TG_UFA_12-16
</td>
<td style="text-align:right;">
0.0054934
</td>
<td style="text-align:right;">
0.3900334
</td>
<td style="text-align:right;">
0.4918451
</td>
<td style="text-align:right;">
1.718446
</td>
</tr>
<tr>
<td style="text-align:left;">
2
</td>
<td style="text-align:left;">
UFA_12-16
</td>
<td style="text-align:right;">
0.0054934
</td>
<td style="text-align:right;">
0.3900334
</td>
<td style="text-align:right;">
0.4918451
</td>
<td style="text-align:right;">
1.718446
</td>
</tr>
<tr>
<td style="text-align:left;">
3
</td>
<td style="text-align:left;">
TG_UFA_16
</td>
<td style="text-align:right;">
0.0353556
</td>
<td style="text-align:right;">
0.9231008
</td>
<td style="text-align:right;">
0.5311323
</td>
<td style="text-align:right;">
1.557537
</td>
</tr>
<tr>
<td style="text-align:left;">
4
</td>
<td style="text-align:left;">
CE_SFA_22-26
</td>
<td style="text-align:right;">
0.0107957
</td>
<td style="text-align:right;">
0.6131947
</td>
<td style="text-align:right;">
0.9663300
</td>
<td style="text-align:right;">
1.482900
</td>
</tr>
<tr>
<td style="text-align:left;">
5
</td>
<td style="text-align:left;">
dhCer_MUFA_22-26
</td>
<td style="text-align:right;">
0.0553889
</td>
<td style="text-align:right;">
0.9231008
</td>
<td style="text-align:right;">
0.8349662
</td>
<td style="text-align:right;">
1.445714
</td>
</tr>
</tbody>
</table>

##### Top 5 negative results

<table class=" lightable-material lightable-striped" style="color: black; font-family: &quot;Source Sans Pro&quot;, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
pathway
</th>
<th style="text-align:right;">
pval
</th>
<th style="text-align:right;">
padj
</th>
<th style="text-align:right;">
ES
</th>
<th style="text-align:right;">
NES
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
279
</td>
<td style="text-align:left;">
FA_12-16
</td>
<td style="text-align:right;">
0.0380273
</td>
<td style="text-align:right;">
0.9231008
</td>
<td style="text-align:right;">
-0.7234549
</td>
<td style="text-align:right;">
-1.551654
</td>
</tr>
<tr>
<td style="text-align:left;">
280
</td>
<td style="text-align:left;">
TG_SFA_18
</td>
<td style="text-align:right;">
0.0290663
</td>
<td style="text-align:right;">
0.9231008
</td>
<td style="text-align:right;">
-0.6814703
</td>
<td style="text-align:right;">
-1.599892
</td>
</tr>
<tr>
<td style="text-align:left;">
281
</td>
<td style="text-align:left;">
HexCER_MUFA_22-26
</td>
<td style="text-align:right;">
0.0257477
</td>
<td style="text-align:right;">
0.9231008
</td>
<td style="text-align:right;">
-0.7464305
</td>
<td style="text-align:right;">
-1.600932
</td>
</tr>
<tr>
<td style="text-align:left;">
282
</td>
<td style="text-align:left;">
HexCER_22-26
</td>
<td style="text-align:right;">
0.0257477
</td>
<td style="text-align:right;">
0.9231008
</td>
<td style="text-align:right;">
-0.7464305
</td>
<td style="text-align:right;">
-1.600932
</td>
</tr>
<tr>
<td style="text-align:left;">
283
</td>
<td style="text-align:left;">
CE_PUFA_18
</td>
<td style="text-align:right;">
0.0049960
</td>
<td style="text-align:right;">
0.3900334
</td>
<td style="text-align:right;">
-0.9360713
</td>
<td style="text-align:right;">
-1.611795
</td>
</tr>
<tr>
<td style="text-align:left;">
284
</td>
<td style="text-align:left;">
CE_17-20
</td>
<td style="text-align:right;">
0.0036014
</td>
<td style="text-align:right;">
0.3900334
</td>
<td style="text-align:right;">
-0.6900139
</td>
<td style="text-align:right;">
-1.842410
</td>
</tr>
</tbody>
</table>

### Lipid species structure annotation

``` r
# LSEA works by annotating the provided lipid species based on their LIPIDMAPS-style name
lipid_anno <- lsea::annotate.lipid.species(rownames(t_df))
```

<table class=" lightable-material lightable-striped" style="color: black; font-family: &quot;Source Sans Pro&quot;, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
Species
</th>
<th style="text-align:left;">
Class
</th>
<th style="text-align:left;">
Category
</th>
<th style="text-align:right;">
Total.Carbons
</th>
<th style="text-align:right;">
Longest.Tail
</th>
<th style="text-align:right;">
Total.DBs
</th>
<th style="text-align:left;">
Saturation
</th>
<th style="text-align:left;">
Chain
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
TG 56:4-FA20:3
</td>
<td style="text-align:left;">
TG.56.4.FA20.3
</td>
<td style="text-align:left;">
TG
</td>
<td style="text-align:left;">
Glycerolipid
</td>
<td style="text-align:right;">
56
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
PUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
TG 49:3-FA18:3
</td>
<td style="text-align:left;">
TG.49.3.FA18.3
</td>
<td style="text-align:left;">
TG
</td>
<td style="text-align:left;">
Glycerolipid
</td>
<td style="text-align:right;">
49
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
PUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
TG 54:5-FA16:0
</td>
<td style="text-align:left;">
TG.54.5.FA16.0
</td>
<td style="text-align:left;">
TG
</td>
<td style="text-align:left;">
Glycerolipid
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
PUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
FA 20:3
</td>
<td style="text-align:left;">
FA.20.3
</td>
<td style="text-align:left;">
FA
</td>
<td style="text-align:left;">
Fatty.Acyl
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
PUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
TG 52:6-FA20:5
</td>
<td style="text-align:left;">
TG.52.6.FA20.5
</td>
<td style="text-align:left;">
TG
</td>
<td style="text-align:left;">
Glycerolipid
</td>
<td style="text-align:right;">
52
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:left;">
PUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
PC 18:2_20:2
</td>
<td style="text-align:left;">
PC.18.2.20.2
</td>
<td style="text-align:left;">
PC
</td>
<td style="text-align:left;">
Glycerophospholipid
</td>
<td style="text-align:right;">
38
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
PUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
TG 52:4-FA18:2
</td>
<td style="text-align:left;">
TG.52.4.FA18.2
</td>
<td style="text-align:left;">
TG
</td>
<td style="text-align:left;">
Glycerolipid
</td>
<td style="text-align:right;">
52
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
PUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
CE 17:0
</td>
<td style="text-align:left;">
CE.17.0
</td>
<td style="text-align:left;">
CE
</td>
<td style="text-align:left;">
Sterol
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
SFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
PE P-16:0/16:1
</td>
<td style="text-align:left;">
PE.P.16.0.16.1
</td>
<td style="text-align:left;">
PE.P
</td>
<td style="text-align:left;">
Ether
</td>
<td style="text-align:right;">
32
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
MUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
TG 56:6-FA22:4
</td>
<td style="text-align:left;">
TG.56.6.FA22.4
</td>
<td style="text-align:left;">
TG
</td>
<td style="text-align:left;">
Glycerolipid
</td>
<td style="text-align:right;">
56
</td>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:left;">
PUFA
</td>
<td style="text-align:left;">
VLCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
CE 18:1
</td>
<td style="text-align:left;">
CE.18.1
</td>
<td style="text-align:left;">
CE
</td>
<td style="text-align:left;">
Sterol
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
MUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
CE 18:4
</td>
<td style="text-align:left;">
CE.18.4
</td>
<td style="text-align:left;">
CE
</td>
<td style="text-align:left;">
Sterol
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
PUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
TG 49:2-FA17:0
</td>
<td style="text-align:left;">
TG.49.2.FA17.0
</td>
<td style="text-align:left;">
TG
</td>
<td style="text-align:left;">
Glycerolipid
</td>
<td style="text-align:right;">
49
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
UFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
FA 16:1
</td>
<td style="text-align:left;">
FA.16.1
</td>
<td style="text-align:left;">
FA
</td>
<td style="text-align:left;">
Fatty.Acyl
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
MUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
<tr>
<td style="text-align:left;">
TG 58:9-FA18:1
</td>
<td style="text-align:left;">
TG.58.9.FA18.1
</td>
<td style="text-align:left;">
TG
</td>
<td style="text-align:left;">
Glycerolipid
</td>
<td style="text-align:right;">
58
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:left;">
PUFA
</td>
<td style="text-align:left;">
LCFA
</td>
</tr>
</tbody>
</table>

### Visualizing differential lipid species enrichment

##### Plot the differential lipid species by longest tail length, number of double bonds, and class

``` r
# for the purposes of this example we will raise the adjusted p-value threshold
# since there are not many significant differences with this simulated data
lsea::structure.enrichment.plot(
  de_tbl = t_df, anno_tbl = lipid_anno, group_names = c("A", "B"),
  p_thresh = 0.96, color_pal = c("dodgerblue", "firebrick"), size_range = c(0.25, 2.5),
)
```

![](index_files/figure-gfm/unnamed-chunk-12-1.png)<!-- -->

``` r
# or specify a Lipid Class
lsea::structure.enrichment.plot(
  de_tbl = t_df, anno_tbl = lipid_anno, group_names = c("A", "B"),
  p_thresh = 0.96, color_pal = c("dodgerblue", "firebrick"), size_range = c(0.25, 2.5), class = "TG"
)
```

![](index_files/figure-gfm/unnamed-chunk-13-1.png)<!-- -->
